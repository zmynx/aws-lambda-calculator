"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.styleMap = exports.CliIoHost = void 0;
const chalk = require("chalk");
/**
 * A simple IO host for the CLI that writes messages to the console.
 */
class CliIoHost {
    /**
     * Returns the singleton instance
     */
    static getIoHost() {
        if (!CliIoHost.instance) {
            CliIoHost.instance = new CliIoHost();
        }
        return CliIoHost.instance;
    }
    /**
     * Determines which output stream to use based on log level and configuration.
     */
    static getStream(level, forceStdout) {
        // For legacy purposes all log streams are written to stderr by default, unless
        // specified otherwise, by passing `forceStdout`, which is used by the `data()` logging function, or
        // if the CDK is running in a CI environment. This is because some CI environments will immediately
        // fail if stderr is written to. In these cases, we detect if we are in a CI environment and
        // write all messages to stdout instead.
        if (forceStdout) {
            return process.stdout;
        }
        if (level == 'error')
            return process.stderr;
        return this.ci ? process.stdout : process.stderr;
    }
    constructor() {
        this.isTTY = process.stdout.isTTY ?? false;
        this.ci = false;
    }
    static get currentAction() {
        return CliIoHost.getIoHost().currentAction;
    }
    static set currentAction(action) {
        CliIoHost.getIoHost().currentAction = action;
    }
    static get ci() {
        return CliIoHost.getIoHost().ci;
    }
    static set ci(value) {
        CliIoHost.getIoHost().ci = value;
    }
    static get isTTY() {
        return CliIoHost.getIoHost().isTTY;
    }
    static set isTTY(value) {
        CliIoHost.getIoHost().isTTY = value;
    }
    /**
     * Notifies the host of a message.
     * The caller waits until the notification completes.
     */
    async notify(msg) {
        const output = this.formatMessage(msg);
        const stream = CliIoHost.getStream(msg.level, msg.forceStdout ?? false);
        return new Promise((resolve, reject) => {
            stream.write(output, (err) => {
                if (err) {
                    reject(err);
                }
                else {
                    resolve();
                }
            });
        });
    }
    /**
     * Formats a message for console output with optional color support
     */
    formatMessage(msg) {
        // apply provided style or a default style if we're in TTY mode
        let message_text = this.isTTY
            ? exports.styleMap[msg.level](msg.message)
            : msg.message;
        // prepend timestamp if IoMessageLevel is DEBUG or TRACE. Postpend a newline.
        return ((msg.level === 'debug' || msg.level === 'trace')
            ? `[${this.formatTime(msg.time)}] ${message_text}`
            : message_text) + '\n';
    }
    /**
     * Formats date to HH:MM:SS
     */
    formatTime(d) {
        const pad = (n) => n.toString().padStart(2, '0');
        return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
    }
}
exports.CliIoHost = CliIoHost;
exports.styleMap = {
    error: chalk.red,
    warn: chalk.yellow,
    info: chalk.white,
    debug: chalk.gray,
    trace: chalk.gray,
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpLWlvLWhvc3QuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJjbGktaW8taG9zdC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSwrQkFBK0I7QUFrRS9COztHQUVHO0FBQ0gsTUFBYSxTQUFTO0lBQ3BCOztPQUVHO0lBQ0gsTUFBTSxDQUFDLFNBQVM7UUFDZCxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsRUFBRSxDQUFDO1lBQ3hCLFNBQVMsQ0FBQyxRQUFRLEdBQUcsSUFBSSxTQUFTLEVBQUUsQ0FBQztRQUN2QyxDQUFDO1FBQ0QsT0FBTyxTQUFTLENBQUMsUUFBUSxDQUFDO0lBQzVCLENBQUM7SUFPRDs7T0FFRztJQUNLLE1BQU0sQ0FBQyxTQUFTLENBQUMsS0FBcUIsRUFBRSxXQUFvQjtRQUNsRSwrRUFBK0U7UUFDL0Usb0dBQW9HO1FBQ3BHLG1HQUFtRztRQUNuRyw0RkFBNEY7UUFDNUYsd0NBQXdDO1FBQ3hDLElBQUksV0FBVyxFQUFFLENBQUM7WUFDaEIsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQ3hCLENBQUM7UUFDRCxJQUFJLEtBQUssSUFBSSxPQUFPO1lBQUUsT0FBTyxPQUFPLENBQUMsTUFBTSxDQUFDO1FBQzVDLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLE1BQU0sQ0FBQztJQUNuRCxDQUFDO0lBcUJEO1FBQ0UsSUFBSSxDQUFDLEtBQUssR0FBRyxPQUFPLENBQUMsTUFBTSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUM7UUFDM0MsSUFBSSxDQUFDLEVBQUUsR0FBRyxLQUFLLENBQUM7SUFDbEIsQ0FBQztJQUVNLE1BQU0sS0FBSyxhQUFhO1FBQzdCLE9BQU8sU0FBUyxDQUFDLFNBQVMsRUFBRSxDQUFDLGFBQWEsQ0FBQztJQUM3QyxDQUFDO0lBRU0sTUFBTSxLQUFLLGFBQWEsQ0FBQyxNQUFxQjtRQUNuRCxTQUFTLENB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bSAnY2hhbGsnO1xuXG5leHBvcnQgdHlwZSBJb01lc3NhZ2VDb2RlQ2F0ZWdvcnkgPSAnVE9PTEtJVCcgfCAnU0RLJyB8ICdBU1NFVFMnO1xuZXhwb3J0IHR5cGUgSW9Db2RlTGV2ZWwgPSAnRScgfCAnVycgfCAnSSc7XG5leHBvcnQgdHlwZSBJb01lc3NhZ2VTcGVjaWZpY0NvZGU8TCBleHRlbmRzIElvQ29kZUxldmVsPiA9IGBDREtfJHtJb01lc3NhZ2VDb2RlQ2F0ZWdvcnl9XyR7TH0ke251bWJlcn0ke251bWJlcn0ke251bWJlcn0ke251bWJlcn1gO1xuZXhwb3J0IHR5cGUgSW9NZXNzYWdlQ29kZSA9IElvTWVzc2FnZVNwZWNpZmljQ29kZTxJb0NvZGVMZXZlbD47XG5cbi8qKlxuICogQmFzaWMgbWVzc2FnZSBzdHJ1Y3R1cmUgZm9yIHRvb2xraXQgbm90aWZpY2F0aW9ucy5cbiAqIE1lc3NhZ2VzIGFyZSBlbWl0dGVkIGJ5IHRoZSB0b29sa2l0IGFuZCBoYW5kbGVkIGJ5IHRoZSBJb0hvc3QuXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgSW9NZXNzYWdlIHtcbiAgLyoqXG4gICAqIFRoZSB0aW1lIHRoZSBtZXNzYWdlIHdhcyBlbWl0dGVkLlxuICAgKi9cbiAgcmVhZG9ubHkgdGltZTogRGF0ZTtcblxuICAvKipcbiAgICogVGhlIGxvZyBsZXZlbCBvZiB0aGUgbWVzc2FnZS5cbiAgICovXG4gIHJlYWRvbmx5IGxldmVsOiBJb01lc3NhZ2VMZXZlbDtcblxuICAvKipcbiAgICogVGhlIGFjdGlvbiB0aGF0IHRyaWdnZXJlZCB0aGUgbWVzc2FnZS5cbiAgICovXG4gIHJlYWRvbmx5IGFjdGlvbjogVG9vbGtpdEFjdGlvbjtcblxuICAvKipcbiAgICogQSBzaG9ydCBtZXNzYWdlIGNvZGUgdW5pcXVlbHkgaWRlbnRpZnlpbmcgYSBtZXNzYWdlIHR5cGUgdXNpbmcgdGhlIGZvcm1hdCBDREtfW0NBVEVHT1JZXV9bRS9XL0ldWzAwMC05OTldLlxuICAgKlxuICAgKiBUaGUgbGV2ZWwgaW5kaWNhdG9yIGZvbGxvd3MgdGhlc2UgcnVsZXM6XG4gICAqIC0gJ0UnIGZvciBlcnJvciBsZXZlbCBtZXNzYWdlc1xuICAgKiAtICdXJyBmb3Igd2FybmluZyBsZXZlbCBtZXNzYWdlc1xuICAgKiAtICdJJyBmb3IgaW5mby9kZWJ1Zy90cmFjZSBsZXZlbCBtZXNzYWdlc1xuICAgKlxuICAgKiBDb2RlcyBlbmRpbmcgaW4gMDAwIGFyZSBnZW5lcmljIG1lc3NhZ2VzLCB3aGlsZSBjb2RlcyBlbmRpbmcgaW4gMDAxLTk5OSBhcmUgc3BlY2lmaWMgdG8gYSBwYXJ0aWN1bGFyIG1lc3NhZ2UuXG4gICAqIFRoZSBmb2xsb3dpbmcgYXJlIGV4YW1wbGVzIG9mIHZhbGlkIGFuZCBpbnZhbGlkIG1lc3NhZ2UgY29kZXM6XG4gICAqIGBgYHRzXG4gICAqICdDREtfQVNTRVRTX0kwMDAnICAgICAgIC8vIHZhbGlkOiBnZW5lcmljIGFzc2V0cyBpbmZvIG1lc3NhZ2VcbiAgICogJ0NES19UT09MS0lUX0UwMDInICAgICAgLy8gdmFsaWQ6IHNwZWNpZmljIHRvb2xraXQgZXJyb3IgbWVzc2FnZVxuICAgKiAnQ0RLX1NES19XMDIzJyAgICAgICAgICAvLyB2YWxpZDogc3BlY2lmaWMgc2RrIHdhcm5pbmcgbWVzc2FnZVxuICAgKiBgYGBcbiAgICovXG4gIHJlYWRvbmx5IGNvZGU6IElvTWVzc2FnZUNvZGU7XG5cbiAgLyoqXG4gICAqIFRoZSBtZXNzYWdlIHRleHQuXG4gICAqL1xuICByZWFkb25seSBtZXNzYWdlOiBzdHJpbmc7XG5cbiAgLyoqXG4gICAqIElmIHRydWUsIHRoZSBtZXNzYWdlIHdpbGwgYmUgd3JpdHRlbiB0byBzdGRvdXRcbiAgICogcmVnYXJkbGVzcyBvZiBhbnkgb3RoZXIgcGFyYW1ldGVycy5cbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHJlYWRvbmx5IGZvcmNlU3Rkb3V0PzogYm9vbGVhbjtcbn1cblxuZXhwb3J0IHR5cGUgSW9NZXNzYWdlTGV2ZWwgPSAnZXJyb3InIHwgJ3dhcm4nIHwgJ2luZm8nIHwgJ2RlYnVnJyB8ICd0cmFjZSc7XG5cbi8qKlxuICogVGhlIGN1cnJlbnQgYWN0aW9uIGJlaW5nIHBlcmZvcm1lZCBieSB0aGUgQ0xJLiAnbm9uZScgcmVwcmVzZW50cyB0aGUgYWJzZW5jZSBvZiBhbiBhY3Rpb24uXG4gKi9cbmV4cG9ydCB0eXBlIFRvb2xraXRBY3Rpb24gPSAnc3ludGgnIHwgJ2xpc3QnIHwgJ2RlcGxveScgfCAnZGVzdHJveScgfCAnbm9uZSc7XG5cbi8qKlxuICogQSBzaW1wbGUgSU8gaG9zdCBmb3IgdGhlIENMSSB0aGF0IHdyaXRlcyBtZXNzYWdlcyB0byB0aGUgY29uc29sZS5cbiAqL1xuZXhwb3J0IGNsYXNzIENsaUlvSG9zdCB7XG4gIC8qKlxuICAgKiBSZXR1cm5zIHRoZSBzaW5nbGV0b24gaW5zdGFuY2VcbiAgICovXG4gIHN0YXRpYyBnZXRJb0hvc3QoKTogQ2xpSW9Ib3N0IHtcbiAgICBpZiAoIUNsaUlvSG9zdC5pbnN0YW5jZSkge1xuICAgICAgQ2xpSW9Ib3N0Lmluc3RhbmNlID0gbmV3IENsaUlvSG9zdCgpO1xuICAgIH1cbiAgICByZXR1cm4gQ2xpSW9Ib3N0Lmluc3RhbmNlO1xuICB9XG5cbiAgLyoqXG4gICAqIFNpbmdsZXRvbiBpbnN0YW5jZSBvZiB0aGUgQ2xpSW9Ib3N0XG4gICAqL1xuICBwcml2YXRlIHN0YXRpYyBpbnN0YW5jZTogQ2xpSW9Ib3N0IHwgdW5kZWZpbmVkO1xuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmVzIHdoaWNoIG91dHB1dCBzdHJlYW0gdG8gdXNlIGJhc2VkIG9uIGxvZyBsZXZlbCBhbmQgY29uZmlndXJhdGlvbi5cbiAgICovXG4gIHByaXZhdGUgc3RhdGljIGdldFN0cmVhbShsZXZlbDogSW9NZXNzYWdlTGV2ZWwsIGZvcmNlU3Rkb3V0OiBib29sZWFuKSB7XG4gICAgLy8gRm9yIGxlZ2FjeSBwdXJwb3NlcyBhbGwgbG9nIHN0cmVhbXMgYXJlIHdyaXR0ZW4gdG8gc3RkZXJyIGJ5IGRlZmF1bHQsIHVubGVzc1xuICAgIC8vIHNwZWNpZmllZCBvdGhlcndpc2UsIGJ5IHBhc3NpbmcgYGZvcmNlU3Rkb3V0YCwgd2hpY2ggaXMgdXNlZCBieSB0aGUgYGRhdGEoKWAgbG9nZ2luZyBmdW5jdGlvbiwgb3JcbiAgICAvLyBpZiB0aGUgQ0RLIGlzIHJ1bm5pbmcgaW4gYSBDSSBlbnZpcm9ubWVudC4gVGhpcyBpcyBiZWNhdXNlIHNvbWUgQ0kgZW52aXJvbm1lbnRzIHdpbGwgaW1tZWRpYXRlbHlcbiAgICAvLyBmYWlsIGlmIHN0ZGVyciBpcyB3cml0dGVuIHRvLiBJbiB0aGVzZSBjYXNlcywgd2UgZGV0ZWN0IGlmIHdlIGFyZSBpbiBhIENJIGVudmlyb25tZW50IGFuZFxuICAgIC8vIHdyaXRlIGFsbCBtZXNzYWdlcyB0byBzdGRvdXQgaW5zdGVhZC5cbiAgICBpZiAoZm9yY2VTdGRvdXQpIHtcbiAgICAgIHJldHVybiBwcm9jZXNzLnN0ZG91dDtcbiAgICB9XG4gICAgaWYgKGxldmVsID09ICdlcnJvcicpIHJldHVybiBwcm9jZXNzLnN0ZGVycjtcbiAgICByZXR1cm4gdGhpcy5jaSA/IHByb2Nlc3Muc3Rkb3V0IDogcHJvY2Vzcy5zdGRlcnI7XG4gIH1cblxuICAvKipcbiAgICogV2hldGhlciB0aGUgaG9zdCBzaG91bGQgYXBwbHkgY2hhbGsgc3R5bGVzIHRvIG1lc3NhZ2VzLiBEZWZhdWx0cyB0byBmYWxzZSBpZiB0aGUgaG9zdCBpcyBub3QgcnVubmluZyBpbiBhIFRUWS5cbiAgICpcbiAgICogQGRlZmF1bHQgZmFsc2VcbiAgICovXG4gIHByaXZhdGUgaXNUVFk6IGJvb2xlYW47XG5cbiAgLyoqXG4gICAqIFdoZXRoZXIgdGhlIENsaUlvSG9zdCBpcyBydW5uaW5nIGluIENJIG1vZGUuIEluIENJIG1vZGUsIGFsbCBub24tZXJyb3Igb3V0cHV0IGdvZXMgdG8gc3Rkb3V0IGluc3RlYWQgb2Ygc3RkZXJyLlxuICAgKlxuICAgKiBTZXQgdG8gZmFsc2UgaW4gdGhlIENsaUlvSG9zdCBjb25zdHJ1Y3RvciBpdCB3aWxsIGJlIG92ZXJ3cml0dGVuIGlmIHRoZSBDTEkgQ0kgYXJndW1lbnQgaXMgcGFzc2VkXG4gICAqL1xuICBwcml2YXRlIGNpOiBib29sZWFuO1xuXG4gIC8qKlxuICAgKiB0aGUgY3VycmVudCB7QGxpbmsgVG9vbGtpdEFjdGlvbn0gc2V0IGJ5IHRoZSBDTEkuXG4gICAqL1xuICBwcml2YXRlIGN1cnJlbnRBY3Rpb246IFRvb2xraXRBY3Rpb24gfCB1bmRlZmluZWQ7XG5cbiAgcHJpdmF0ZSBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLmlzVFRZID0gcHJvY2Vzcy5zdGRvdXQuaXNUVFkgPz8gZmFsc2U7XG4gICAgdGhpcy5jaSA9IGZhbHNlO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXQgY3VycmVudEFjdGlvbigpOiBUb29sa2l0QWN0aW9uIHwgdW5kZWZpbmVkIHtcbiAgICByZXR1cm4gQ2xpSW9Ib3N0LmdldElvSG9zdCgpLmN1cnJlbnRBY3Rpb247XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIHNldCBjdXJyZW50QWN0aW9uKGFjdGlvbjogVG9vbGtpdEFjdGlvbikge1xuICAgIENsaUlvSG9zdC5nZXRJb0hvc3QoKS5jdXJyZW50QWN0aW9uID0gYWN0aW9uO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBnZXQgY2koKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIENsaUlvSG9zdC5nZXRJb0hvc3QoKS5jaTtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgc2V0IGNpKHZhbHVlOiBib29sZWFuKSB7XG4gICAgQ2xpSW9Ib3N0LmdldElvSG9zdCgpLmNpID0gdmFsdWU7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGdldCBpc1RUWSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gQ2xpSW9Ib3N0LmdldElvSG9zdCgpLmlzVFRZO1xuICB9XG5cbiAgcHVibGljIHN0YXRpYyBzZXQgaXNUVFkodmFsdWU6IGJvb2xlYW4pIHtcbiAgICBDbGlJb0hvc3QuZ2V0SW9Ib3N0KCkuaXNUVFkgPSB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBOb3RpZmllcyB0aGUgaG9zdCBvZiBhIG1lc3NhZ2UuXG4gICAqIFRoZSBjYWxsZXIgd2FpdHMgdW50aWwgdGhlIG5vdGlmaWNhdGlvbiBjb21wbGV0ZXMuXG4gICAqL1xuICBhc3luYyBub3RpZnkobXNnOiBJb01lc3NhZ2UpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBvdXRwdXQgPSB0aGlzLmZvcm1hdE1lc3NhZ2UobXNnKTtcblxuICAgIGNvbnN0IHN0cmVhbSA9IENsaUlvSG9zdC5nZXRTdHJlYW0obXNnLmxldmVsLCBtc2cuZm9yY2VTdGRvdXQgPz8gZmFsc2UpO1xuXG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgIHN0cmVhbS53cml0ZShvdXRwdXQsIChlcnIpID0+IHtcbiAgICAgICAgaWYgKGVycikge1xuICAgICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRm9ybWF0cyBhIG1lc3NhZ2UgZm9yIGNvbnNvbGUgb3V0cHV0IHdpdGggb3B0aW9uYWwgY29sb3Igc3VwcG9ydFxuICAgKi9cbiAgcHJpdmF0ZSBmb3JtYXRNZXNzYWdlKG1zZzogSW9NZXNzYWdlKTogc3RyaW5nIHtcbiAgICAvLyBhcHBseSBwcm92aWRlZCBzdHlsZSBvciBhIGRlZmF1bHQgc3R5bGUgaWYgd2UncmUgaW4gVFRZIG1vZGVcbiAgICBsZXQgbWVzc2FnZV90ZXh0ID0gdGhpcy5pc1RUWVxuICAgICAgPyBzdHlsZU1hcFttc2cubGV2ZWxdKG1zZy5tZXNzYWdlKVxuICAgICAgOiBtc2cubWVzc2FnZTtcblxuICAgIC8vIHByZXBlbmQgdGltZXN0YW1wIGlmIElvTWVzc2FnZUxldmVsIGlzIERFQlVHIG9yIFRSQUNFLiBQb3N0cGVuZCBhIG5ld2xpbmUuXG4gICAgcmV0dXJuICgobXNnLmxldmVsID09PSAnZGVidWcnIHx8IG1zZy5sZXZlbCA9PT0gJ3RyYWNlJylcbiAgICAgID8gYFske3RoaXMuZm9ybWF0VGltZShtc2cudGltZSl9XSAke21lc3NhZ2VfdGV4dH1gXG4gICAgICA6IG1lc3NhZ2VfdGV4dCkgKyAnXFxuJztcbiAgfVxuXG4gIC8qKlxuICAgKiBGb3JtYXRzIGRhdGUgdG8gSEg6TU06U1NcbiAgICovXG4gIHByaXZhdGUgZm9ybWF0VGltZShkOiBEYXRlKTogc3RyaW5nIHtcbiAgICBjb25zdCBwYWQgPSAobjogbnVtYmVyKTogc3RyaW5nID0+IG4udG9TdHJpbmcoKS5wYWRTdGFydCgyLCAnMCcpO1xuICAgIHJldHVybiBgJHtwYWQoZC5nZXRIb3VycygpKX06JHtwYWQoZC5nZXRNaW51dGVzKCkpfToke3BhZChkLmdldFNlY29uZHMoKSl9YDtcbiAgfVxufVxuXG5leHBvcnQgY29uc3Qgc3R5bGVNYXA6IFJlY29yZDxJb01lc3NhZ2VMZXZlbCwgKHN0cjogc3RyaW5nKSA9PiBzdHJpbmc+ID0ge1xuICBlcnJvcjogY2hhbGsucmVkLFxuICB3YXJuOiBjaGFsay55ZWxsb3csXG4gIGluZm86IGNoYWxrLndoaXRlLFxuICBkZWJ1ZzogY2hhbGsuZ3JheSxcbiAgdHJhY2U6IGNoYWxrLmdyYXksXG59O1xuIl19