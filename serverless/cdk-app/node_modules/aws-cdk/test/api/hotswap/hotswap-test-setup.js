"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.HotswapMockSdkProvider = exports.STACK_ID = void 0;
exports.setupHotswapTests = setupHotswapTests;
exports.setupHotswapNestedStackTests = setupHotswapNestedStackTests;
exports.cdkStackArtifactOf = cdkStackArtifactOf;
exports.pushStackResourceSummaries = pushStackResourceSummaries;
exports.pushNestedStackResourceSummaries = pushNestedStackResourceSummaries;
exports.setCurrentCfnStackTemplate = setCurrentCfnStackTemplate;
exports.addTemplateToCloudFormationLookupMock = addTemplateToCloudFormationLookupMock;
exports.stackSummaryOf = stackSummaryOf;
const client_cloudformation_1 = require("@aws-sdk/client-cloudformation");
const client_lambda_1 = require("@aws-sdk/client-lambda");
const common_1 = require("../../../lib/api/hotswap/common");
const deployments = require("../../../lib/api/hotswap-deployments");
const cloudformation_1 = require("../../../lib/api/util/cloudformation");
const util_1 = require("../../util");
const mock_sdk_1 = require("../../util/mock-sdk");
const fake_cloudformation_stack_1 = require("../fake-cloudformation-stack");
const STACK_NAME = 'withouterrors';
exports.STACK_ID = 'stackId';
let hotswapMockSdkProvider;
let currentCfnStack;
const currentCfnStackResources = [];
let stackTemplates;
let currentNestedCfnStackResources;
function setupHotswapTests() {
    (0, mock_sdk_1.restoreSdkMocksToDefault)();
    (0, mock_sdk_1.setDefaultSTSMocks)();
    jest.resetAllMocks();
    // clear the array
    currentCfnStackResources.splice(0);
    hotswapMockSdkProvider = new HotswapMockSdkProvider();
    currentCfnStack = new fake_cloudformation_stack_1.FakeCloudformationStack({
        stackName: STACK_NAME,
        stackId: exports.STACK_ID,
    });
    cloudformation_1.CloudFormationStack.lookup = async (_, _stackName) => {
        return currentCfnStack;
    };
    return hotswapMockSdkProvider;
}
function setupHotswapNestedStackTests(rootStackName) {
    (0, mock_sdk_1.restoreSdkMocksToDefault)();
    (0, mock_sdk_1.setDefaultSTSMocks)();
    jest.resetAllMocks();
    currentNestedCfnStackResources = {};
    hotswapMockSdkProvider = new HotswapMockSdkProvider(rootStackName);
    currentCfnStack = new fake_cloudformation_stack_1.FakeCloudformationStack({
        stackName: rootStackName,
        stackId: exports.STACK_ID,
    });
    stackTemplates = {};
    cloudformation_1.CloudFormationStack.lookup = async (_, stackName) => {
        currentCfnStack.template = async () => stackTemplates[stackName];
        return currentCfnStack;
    };
    return hotswapMockSdkProvider;
}
function cdkStackArtifactOf(testStackArtifact = {}) {
    return (0, util_1.testStack)({
        stackName: STACK_NAME,
        ...testStackArtifact,
    });
}
function pushStackResourceSummaries(...items) {
    currentCfnStackResources.push(...items);
}
function pushNestedStackResourceSummaries(stackName, ...items) {
    if (!currentNestedCfnStackResources[stackName]) {
        currentNestedCfnStackResources[stackName] = [];
    }
    currentNestedCfnStackResources[stackName].push(...items);
}
function setCurrentCfnStackTemplate(template) {
    const templateDeepCopy = JSON.parse(JSON.stringify(template)); // deep copy the template, so our tests can mutate one template instead of creating two
    currentCfnStack.setTemplate(templateDeepCopy);
}
function addTemplateToCloudFormationLookupMock(stackArtifact) {
    const templateDeepCopy = JSON.parse(JSON.stringify(stackArtifact.template)); // deep copy the template, so our tests can mutate one template instead of creating two
    stackTemplates[stackArtifact.stackName] = templateDeepCopy;
}
function stackSummaryOf(logicalId, resourceType, physicalResourceId) {
    return {
        LogicalResourceId: logicalId,
        PhysicalResourceId: physicalResourceId,
        ResourceType: resourceType,
        ResourceStatus: client_cloudformation_1.StackStatus.CREATE_COMPLETE,
        LastUpdatedTimestamp: new Date(),
    };
}
class HotswapMockSdkProvider extends mock_sdk_1.MockSdkProvider {
    constructor(rootStackName) {
        super();
        mock_sdk_1.mockLambdaClient.on(client_lambda_1.GetFunctionCommand).resolves({
            Configuration: {
                LastUpdateStatus: 'Successful',
            },
        });
        mock_sdk_1.mockCloudFormationClient.on(client_cloudformation_1.ListStackResourcesCommand).callsFake((input) => {
            if (rootStackName) {
                const knownStackNames = Object.keys(currentNestedCfnStackResources);
                if (input.StackName !== rootStackName && !knownStackNames.includes(input.StackName)) {
                    throw new Error(`Expected Stack name in listStackResources() call to be a member of ['${rootStackName}, ${knownStackNames}'], but received: '${input.StackName}'`);
                }
            }
            else if (input.StackName !== STACK_NAME) {
                throw new Error(`Expected Stack name in listStackResources() call to be: '${STACK_NAME}', but received: '${input.StackName}'`);
            }
            return {
                StackResourceSummaries: rootStackName
                    ? currentNestedCfnStackResources[input.StackName]
                    : currentCfnStackResources,
            };
        });
    }
    tryHotswapDeployment(hotswapMode, stackArtifact, assetParams = {}, hotswapPropertyOverrides) {
        let hotswapProps = hotswapPropertyOverrides || new common_1.HotswapPropertyOverrides();
        return deployments.tryHotswapDeployment(this, assetParams, currentCfnStack, stackArtifact, hotswapMode, hotswapProps);
    }
}
exports.HotswapMockSdkProvider = HotswapMockSdkProvider;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaG90c3dhcC10ZXN0LXNldHVwLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiaG90c3dhcC10ZXN0LXNldHVwLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQTBCQSw4Q0FnQkM7QUFFRCxvRUFpQkM7QUFFRCxnREFPQztBQUVELGdFQUVDO0FBRUQsNEVBS0M7QUFFRCxnRUFHQztBQUVELHNGQUdDO0FBRUQsd0NBWUM7QUF4R0QsMEVBQThHO0FBQzlHLDBEQUE0RDtBQUU1RCw0REFBd0Y7QUFDeEYsb0VBQW9FO0FBQ3BFLHlFQUFxRjtBQUNyRixxQ0FBMEQ7QUFDMUQsa0RBTTZCO0FBQzdCLDRFQUF1RTtBQUV2RSxNQUFNLFVBQVUsR0FBRyxlQUFlLENBQUM7QUFDdEIsUUFBQSxRQUFRLEdBQUcsU0FBUyxDQUFDO0FBRWxDLElBQUksc0JBQThDLENBQUM7QUFDbkQsSUFBSSxlQUF3QyxDQUFDO0FBQzdDLE1BQU0sd0JBQXdCLEdBQTJCLEVBQUUsQ0FBQztBQUM1RCxJQUFJLGNBQTRDLENBQUM7QUFDakQsSUFBSSw4QkFBK0UsQ0FBQztBQUVwRixTQUFnQixpQkFBaUI7SUFDL0IsSUFBQSxtQ0FBd0IsR0FBRSxDQUFDO0lBQzNCLElBQUEsNkJBQWtCLEdBQUUsQ0FBQztJQUNyQixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7SUFDckIsa0JBQWtCO0lBQ2xCLHdCQUF3QixDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUNuQyxzQkFBc0IsR0FBRyxJQUFJLHNCQUFzQixFQUFFLENBQUM7SUFDdEQsZUFBZSxHQUFHLElBQUksbURBQXVCLENBQUM7UUFDNUMsU0FBUyxFQUFFLFVBQVU7UUFDckIsT0FBTyxFQUFFLGdCQUFRO0tBQ2xCLENBQUMsQ0FBQztJQUNILG9DQUFtQixDQUFDLE1BQU0sR0FBRyxLQUFLLEVBQUUsQ0FBd0IsRUFBRSxVQUFrQixFQUFFLEVBQUU7UUFDbEYsT0FBTyxlQUFlLENBQUM7SUFDekIsQ0FBQyxDQUFDO0lB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d3MtY2RrL2N4LWFwaSc7XG5pbXBvcnQgeyBMaXN0U3RhY2tSZXNvdXJjZXNDb21tYW5kLCBTdGFja1Jlc291cmNlU3VtbWFyeSwgU3RhY2tTdGF0dXMgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtY2xvdWRmb3JtYXRpb24nO1xuaW1wb3J0IHsgR2V0RnVuY3Rpb25Db21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWxhbWJkYSc7XG5pbXBvcnQgeyBJQ2xvdWRGb3JtYXRpb25DbGllbnQsIFN1Y2Nlc3NmdWxEZXBsb3lTdGFja1Jlc3VsdCB9IGZyb20gJy4uLy4uLy4uL2xpYi9hcGknO1xuaW1wb3J0IHsgSG90c3dhcE1vZGUsIEhvdHN3YXBQcm9wZXJ0eU92ZXJyaWRlcyB9IGZyb20gJy4uLy4uLy4uL2xpYi9hcGkvaG90c3dhcC9jb21tb24nO1xuaW1wb3J0ICogYXMgZGVwbG95bWVudHMgZnJvbSAnLi4vLi4vLi4vbGliL2FwaS9ob3Rzd2FwLWRlcGxveW1lbnRzJztcbmltcG9ydCB7IENsb3VkRm9ybWF0aW9uU3RhY2ssIFRlbXBsYXRlIH0gZnJvbSAnLi4vLi4vLi4vbGliL2FwaS91dGlsL2Nsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7IHRlc3RTdGFjaywgVGVzdFN0YWNrQXJ0aWZhY3QgfSBmcm9tICcuLi8uLi91dGlsJztcbmltcG9ydCB7XG4gIG1vY2tDbG91ZEZvcm1hdGlvbkNsaWVudCxcbiAgbW9ja0xhbWJkYUNsaWVudCxcbiAgTW9ja1Nka1Byb3ZpZGVyLFxuICByZXN0b3JlU2RrTW9ja3NUb0RlZmF1bHQsXG4gIHNldERlZmF1bHRTVFNNb2Nrcyxcbn0gZnJvbSAnLi4vLi4vdXRpbC9tb2NrLXNkayc7XG5pbXBvcnQgeyBGYWtlQ2xvdWRmb3JtYXRpb25TdGFjayB9IGZyb20gJy4uL2Zha2UtY2xvdWRmb3JtYXRpb24tc3RhY2snO1xuXG5jb25zdCBTVEFDS19OQU1FID0gJ3dpdGhvdXRlcnJvcnMnO1xuZXhwb3J0IGNvbnN0IFNUQUNLX0lEID0gJ3N0YWNrSWQnO1xuXG5sZXQgaG90c3dhcE1vY2tTZGtQcm92aWRlcjogSG90c3dhcE1vY2tTZGtQcm92aWRlcjtcbmxldCBjdXJyZW50Q2ZuU3RhY2s6IEZha2VDbG91ZGZvcm1hdGlvblN0YWNrO1xuY29uc3QgY3VycmVudENmblN0YWNrUmVzb3VyY2VzOiBTdGFja1Jlc291cmNlU3VtbWFyeVtdID0gW107XG5sZXQgc3RhY2tUZW1wbGF0ZXM6IHsgW3N0YWNrTmFtZTogc3RyaW5nXTogYW55IH07XG5sZXQgY3VycmVudE5lc3RlZENmblN0YWNrUmVzb3VyY2VzOiB7IFtzdGFja05hbWU6IHN0cmluZ106IFN0YWNrUmVzb3VyY2VTdW1tYXJ5W10gfTtcblxuZXhwb3J0IGZ1bmN0aW9uIHNldHVwSG90c3dhcFRlc3RzKCk6IEhvdHN3YXBNb2NrU2RrUHJvdmlkZXIge1xuICByZXN0b3JlU2RrTW9ja3NUb0RlZmF1bHQoKTtcbiAgc2V0RGVmYXVsdFNUU01vY2tzKCk7XG4gIGplc3QucmVzZXRBbGxNb2NrcygpO1xuICAvLyBjbGVhciB0aGUgYXJyYXlcbiAgY3VycmVudENmblN0YWNrUmVzb3VyY2VzLnNwbGljZSgwKTtcbiAgaG90c3dhcE1vY2tTZGtQcm92aWRlciA9IG5ldyBIb3Rzd2FwTW9ja1Nka1Byb3ZpZGVyKCk7XG4gIGN1cnJlbnRDZm5TdGFjayA9IG5ldyBGYWtlQ2xvdWRmb3JtYXRpb25TdGFjayh7XG4gICAgc3RhY2tOYW1lOiBTVEFDS19OQU1FLFxuICAgIHN0YWNrSWQ6IFNUQUNLX0lELFxuICB9KTtcbiAgQ2xvdWRGb3JtYXRpb25TdGFjay5sb29rdXAgPSBhc3luYyAoXzogSUNsb3VkRm9ybWF0aW9uQ2xpZW50LCBfc3RhY2tOYW1lOiBzdHJpbmcpID0+IHtcbiAgICByZXR1cm4gY3VycmVudENmblN0YWNrO1xuICB9O1xuXG4gIHJldHVybiBob3Rzd2FwTW9ja1Nka1Byb3ZpZGVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gc2V0dXBIb3Rzd2FwTmVzdGVkU3RhY2tUZXN0cyhyb290U3RhY2tOYW1lOiBzdHJpbmcpIHtcbiAgcmVzdG9yZVNka01vY2tzVG9EZWZhdWx0KCk7XG4gIHNldERlZmF1bHRTVFNNb2NrcygpO1xuICBqZXN0LnJlc2V0QWxsTW9ja3MoKTtcbiAgY3VycmVudE5lc3RlZENmblN0YWNrUmVzb3VyY2VzID0ge307XG4gIGhvdHN3YXBNb2NrU2RrUHJvdmlkZXIgPSBuZXcgSG90c3dhcE1vY2tTZGtQcm92aWRlcihyb290U3RhY2tOYW1lKTtcbiAgY3VycmVudENmblN0YWNrID0gbmV3IEZha2VDbG91ZGZvcm1hdGlvblN0YWNrKHtcbiAgICBzdGFja05hbWU6IHJvb3RTdGFja05hbWUsXG4gICAgc3RhY2tJZDogU1RBQ0tfSUQsXG4gIH0pO1xuICBzdGFja1RlbXBsYXRlcyA9IHt9O1xuICBDbG91ZEZvcm1hdGlvblN0YWNrLmxvb2t1cCA9IGFzeW5jIChfOiBJQ2xvdWRGb3JtYXRpb25DbGllbnQsIHN0YWNrTmFtZTogc3RyaW5nKSA9PiB7XG4gICAgY3VycmVudENmblN0YWNrLnRlbXBsYXRlID0gYXN5bmMgKCkgPT4gc3RhY2tUZW1wbGF0ZXNbc3RhY2tOYW1lXTtcbiAgICByZXR1cm4gY3VycmVudENmblN0YWNrO1xuICB9O1xuXG4gIHJldHVybiBob3Rzd2FwTW9ja1Nka1Byb3ZpZGVyO1xufVxuXG5leHBvcnQgZnVuY3Rpb24gY2RrU3RhY2tBcnRpZmFjdE9mKFxuICB0ZXN0U3RhY2tBcnRpZmFjdDogUGFydGlhbDxUZXN0U3RhY2tBcnRpZmFjdD4gPSB7fSxcbik6IGN4YXBpLkNsb3VkRm9ybWF0aW9uU3RhY2tBcnRpZmFjdCB7XG4gIHJldHVybiB0ZXN0U3RhY2soe1xuICAgIHN0YWNrTmFtZTogU1RBQ0tfTkFNRSxcbiAgICAuLi50ZXN0U3RhY2tBcnRpZmFjdCxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwdXNoU3RhY2tSZXNvdXJjZVN1bW1hcmllcyguLi5pdGVtczogU3RhY2tSZXNvdXJjZVN1bW1hcnlbXSkge1xuICBjdXJyZW50Q2ZuU3RhY2tSZXNvdXJjZXMucHVzaCguLi5pdGVtcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwdXNoTmVzdGVkU3RhY2tSZXNvdXJjZVN1bW1hcmllcyhzdGFja05hbWU6IHN0cmluZywgLi4uaXRlbXM6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5W10pIHtcbiAgaWYgKCFjdXJyZW50TmVzdGVkQ2ZuU3RhY2tSZXNvdXJjZXNbc3RhY2tOYW1lXSkge1xuICAgIGN1cnJlbnROZXN0ZWRDZm5TdGFja1Jlc291cmNlc1tzdGFja05hbWVdID0gW107XG4gIH1cbiAgY3VycmVudE5lc3RlZENmblN0YWNrUmVzb3VyY2VzW3N0YWNrTmFtZV0ucHVzaCguLi5pdGVtcyk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzZXRDdXJyZW50Q2ZuU3RhY2tUZW1wbGF0ZSh0ZW1wbGF0ZTogVGVtcGxhdGUpIHtcbiAgY29uc3QgdGVtcGxhdGVEZWVwQ29weSA9IEpTT04ucGFyc2UoSlNPTi5zdHJpbmdpZnkodGVtcGxhdGUpKTsgLy8gZGVlcCBjb3B5IHRoZSB0ZW1wbGF0ZSwgc28gb3VyIHRlc3RzIGNhbiBtdXRhdGUgb25lIHRlbXBsYXRlIGluc3RlYWQgb2YgY3JlYXRpbmcgdHdvXG4gIGN1cnJlbnRDZm5TdGFjay5zZXRUZW1wbGF0ZSh0ZW1wbGF0ZURlZXBDb3B5KTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIGFkZFRlbXBsYXRlVG9DbG91ZEZvcm1hdGlvbkxvb2t1cE1vY2soc3RhY2tBcnRpZmFjdDogY3hhcGkuQ2xvdWRGb3JtYXRpb25TdGFja0FydGlmYWN0KSB7XG4gIGNvbnN0IHRlbXBsYXRlRGVlcENvcHkgPSBKU09OLnBhcnNlKEpTT04uc3RyaW5naWZ5KHN0YWNrQXJ0aWZhY3QudGVtcGxhdGUpKTsgLy8gZGVlcCBjb3B5IHRoZSB0ZW1wbGF0ZSwgc28gb3VyIHRlc3RzIGNhbiBtdXRhdGUgb25lIHRlbXBsYXRlIGluc3RlYWQgb2YgY3JlYXRpbmcgdHdvXG4gIHN0YWNrVGVtcGxhdGVzW3N0YWNrQXJ0aWZhY3Quc3RhY2tOYW1lXSA9IHRlbXBsYXRlRGVlcENvcHk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGFja1N1bW1hcnlPZihcbiAgbG9naWNhbElkOiBzdHJpbmcsXG4gIHJlc291cmNlVHlwZTogc3RyaW5nLFxuICBwaHlzaWNhbFJlc291cmNlSWQ6IHN0cmluZyxcbik6IFN0YWNrUmVzb3VyY2VTdW1tYXJ5IHtcbiAgcmV0dXJuIHtcbiAgICBMb2dpY2FsUmVzb3VyY2VJZDogbG9naWNhbElkLFxuICAgIFBoeXNpY2FsUmVzb3VyY2VJZDogcGh5c2ljYWxSZXNvdXJjZUlkLFxuICAgIFJlc291cmNlVHlwZTogcmVzb3VyY2VUeXBlLFxuICAgIFJlc291cmNlU3RhdHVzOiBTdGFja1N0YXR1cy5DUkVBVEVfQ09NUExFVEUsXG4gICAgTGFzdFVwZGF0ZWRUaW1lc3RhbXA6IG5ldyBEYXRlKCksXG4gIH07XG59XG5cbmV4cG9ydCBjbGFzcyBIb3Rzd2FwTW9ja1Nka1Byb3ZpZGVyIGV4dGVuZHMgTW9ja1Nka1Byb3ZpZGVyIHtcbiAgY29uc3RydWN0b3Iocm9vdFN0YWNrTmFtZT86IHN0cmluZykge1xuICAgIHN1cGVyKCk7XG5cbiAgICBtb2NrTGFtYmRhQ2xpZW50Lm9uKEdldEZ1bmN0aW9uQ29tbWFuZCkucmVzb2x2ZXMoe1xuICAgICAgQ29uZmlndXJhdGlvbjoge1xuICAgICAgICBMYXN0VXBkYXRlU3RhdHVzOiAnU3VjY2Vzc2Z1bCcsXG4gICAgICB9LFxuICAgIH0pO1xuXG4gICAgbW9ja0Nsb3VkRm9ybWF0aW9uQ2xpZW50Lm9uKExpc3RTdGFja1Jlc291cmNlc0NvbW1hbmQpLmNhbGxzRmFrZSgoaW5wdXQpID0+IHtcbiAgICAgIGlmIChyb290U3RhY2tOYW1lKSB7XG4gICAgICAgIGNvbnN0IGtub3duU3RhY2tOYW1lcyA9IE9iamVjdC5rZXlzKGN1cnJlbnROZXN0ZWRDZm5TdGFja1Jlc291cmNlcyk7XG4gICAgICAgIGlmIChpbnB1dC5TdGFja05hbWUgIT09IHJvb3RTdGFja05hbWUgJiYgIWtub3duU3RhY2tOYW1lcy5pbmNsdWRlcyhpbnB1dC5TdGFja05hbWUpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgICAgYEV4cGVjdGVkIFN0YWNrIG5hbWUgaW4gbGlzdFN0YWNrUmVzb3VyY2VzKCkgY2FsbCB0byBiZSBhIG1lbWJlciBvZiBbJyR7cm9vdFN0YWNrTmFtZX0sICR7a25vd25TdGFja05hbWVzfSddLCBidXQgcmVjZWl2ZWQ6ICcke2lucHV0LlN0YWNrTmFtZX0nYCxcbiAgICAgICAgICApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2UgaWYgKGlucHV0LlN0YWNrTmFtZSAhPT0gU1RBQ0tfTkFNRSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXG4gICAgICAgICAgYEV4cGVjdGVkIFN0YWNrIG5hbWUgaW4gbGlzdFN0YWNrUmVzb3VyY2VzKCkgY2FsbCB0byBiZTogJyR7U1RBQ0tfTkFNRX0nLCBidXQgcmVjZWl2ZWQ6ICcke2lucHV0LlN0YWNrTmFtZX0nYCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIHJldHVybiB7XG4gICAgICAgIFN0YWNrUmVzb3VyY2VTdW1tYXJpZXM6IHJvb3RTdGFja05hbWVcbiAgICAgICAgICA/IGN1cnJlbnROZXN0ZWRDZm5TdGFja1Jlc291cmNlc1tpbnB1dC5TdGFja05hbWVdXG4gICAgICAgICAgOiBjdXJyZW50Q2ZuU3RhY2tSZXNvdXJjZXMsXG4gICAgICB9O1xuICAgIH0pO1xuICB9XG5cbiAgcHVibGljIHRyeUhvdHN3YXBEZXBsb3ltZW50KFxuICAgIGhvdHN3YXBNb2RlOiBIb3Rzd2FwTW9kZSxcbiAgICBzdGFja0FydGlmYWN0OiBjeGFwaS5DbG91ZEZvcm1hdGlvblN0YWNrQXJ0aWZhY3QsXG4gICAgYXNzZXRQYXJhbXM6IHsgW2tleTogc3RyaW5nXTogc3RyaW5nIH0gPSB7fSxcbiAgICBob3Rzd2FwUHJvcGVydHlPdmVycmlkZXM/OiBIb3Rzd2FwUHJvcGVydHlPdmVycmlkZXMsXG4gICk6IFByb21pc2U8U3VjY2Vzc2Z1bERlcGxveVN0YWNrUmVzdWx0IHwgdW5kZWZpbmVkPiB7XG4gICAgbGV0IGhvdHN3YXBQcm9wcyA9IGhvdHN3YXBQcm9wZXJ0eU92ZXJyaWRlcyB8fCBuZXcgSG90c3dhcFByb3BlcnR5T3ZlcnJpZGVzKCk7XG4gICAgcmV0dXJuIGRlcGxveW1lbnRzLnRyeUhvdHN3YXBEZXBsb3ltZW50KHRoaXMsIGFzc2V0UGFyYW1zLCBjdXJyZW50Q2ZuU3RhY2ssIHN0YWNrQXJ0aWZhY3QsIGhvdHN3YXBNb2RlLCBob3Rzd2FwUHJvcHMpO1xuICB9XG59XG4iXX0=